# 仙人掌策略

本文用于《The Farmer Was Replaced》脚本策略记录，目标是：正确理解并实现仙人掌的排序机制和连锁收集系统。

## 基本规则

- **种植**：仙人掌可以种植在耕过的土地（`Grounds.Soil`）上
- **收获**：可以像其他植物一样收获
- **大小**：仙人掌大小不一，通过 `measure()` 函数获取，结果为 0-9 之间的整数

## 排序状态（Sorted State）

一个完全成熟的仙人掌被认为是**已排序**的，当且仅当：

- **North（上）和 East（右）方向**：所有相邻的仙人掌都完全成熟，且尺寸 **≥** 自身
- **South（下）和 West（左）方向**：所有相邻的仙人掌都完全成熟，且尺寸 **≤** 自身

### 视觉指示

- **未排序**：完全成熟的仙人掌显示为**棕色**
- **已排序**：完全成熟的仙人掌显示为**绿色**

## 连锁收集（Chain Harvest）

### 触发条件

当所有相邻的仙人掌都**完全成熟**并处于**已排序状态**时，可以触发连锁收集。

### 收集机制

如果收获一株完全成熟的仙人掌，并且所有相邻的仙人掌都已排序，则：

- 所有相邻的仙人掌也会以**递归方式**收获
- 也就是说，如果一个方形区域的成熟仙人掌已经按大小排序，那么收获其中一株仙人掌时，会收获整个方形区域

### 收获奖励

收获 n 个仙人掌时，将获得 **n²** 个 `Items.Cactus`。

例如：

- 收获 1 个仙人掌 → 获得 1 个
- 收获 3 个仙人掌 → 获得 9 个
- 收获 5 个仙人掌 → 获得 25 个

## API 函数

### `measure()`

获取无人机当前位置的仙人掌大小。

- **返回值**：0, 1, 2, 3, 4, 5, 6, 7, 8, 9 之一
- **注意**：未成熟的仙人掌也可以测量大小

### `measure(direction)`

获取无人机指定方向相邻地块的仙人掌大小。

- **参数**：方向（North, South, East, West）
- **返回值**：0-9 之间的整数

### `swap(direction)`

将无人机下方的物体与无人机 `direction` 方向 1 格处的物体交换位置。

- **参数**：方向（North, South, East, West）
- **用途**：用于调整仙人掌位置，实现排序

## 排序示例

以下网格中，所有仙人掌都处于已排序状态，可以连锁收获整片田地：

```
3 4 5    3 3 3    1 2 3    1 5 9
2 3 4    2 2 2    1 2 3    1 3 8
1 2 3    1 1 1    1 2 3    1 3 4
```

在下面网格中，只有左下角的仙人掌（值为 3）处于已排序状态，这还无法触发连锁收集：

```
1 5 3
4 9 7
3 3 2
```

## 实现策略建议

### 1. 排序算法

- 使用 `measure()` 和 `measure(direction)` 获取所有仙人掌的大小
- 使用 `swap(direction)` 调整位置，使整个区域满足排序条件
- 排序目标：让每个位置的仙人掌满足“上右 ≥ 自身，下左 ≤ 自身”

### 2. 区域规划

- 建议使用固定大小的方形区域（如 3×3 或 4×4）
- 优先保证区域内所有仙人掌完全成熟
- 然后进行排序操作，使所有仙人掌变为绿色（已排序状态）

### 3. 收获时机

- 只有当区域内所有仙人掌都**完全成熟**且**已排序**（显示为绿色）时，才进行收获
- 收获任意一株已排序的成熟仙人掌，即可触发连锁收集整片区域

### 4. 耕地处理

- 仙人掌需要种植在 `Grounds.Soil` 上
- 使用 `till()` 切换地面类型（`Grassland ↔ Soil`）
- **重要**：只在需要时才 `till()`，避免误切回草地

## 注意事项

1. **排序是递归的**：相邻仙人掌的排序状态会影响连锁收集的范围
2. **完全成熟是前提**：只有完全成熟的仙人掌才能参与排序和连锁收集
3. **大小范围固定**：仙人掌大小始终在 0-9 之间
4. **视觉反馈**：棕色表示未排序，绿色表示已排序，这是判断状态的重要依据
