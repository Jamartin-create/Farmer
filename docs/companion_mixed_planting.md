# 混合种植 / 伴生植物（Companion）— 提升产量的实现方案

本文记录“混合种植”解锁后的核心机制，以及本仓库脚本（`do_plant.py`）如何利用该机制提升总体产量。

## 规则速记

- 具备伴生属性的植物只有 4 种：
  - `Entities.Grass`、`Entities.Bush`、`Entities.Tree`、`Entities.Carrot`
- 每株带伴生属性的植物都会随机选择：
  - 一个**不同种类**的伴生植物类型
  - 一个目标坐标（在自己周围“三步格”范围内；边界会折返，所以可能出现在地图另一侧）
- `get_companion()`：
  - 若脚下植物有伴生偏好，返回 `(companion_type, (companion_x, companion_y))`
  - 否则返回 `None`
- 只要在目标坐标种上正确的伴生植物，该植物收获时产量更高
  - 伴生植物是否成熟不影响加成（关键是“目标格子上种了什么”）

## 本仓库的实现策略（核心思路）

### 1) 记录需求（需求缓存）

当无人机走到草/灌木/树/胡萝卜上时：

- 调用 `get_companion()` 读取伴生需求
- 将“目标坐标需要种什么”记录到一个二维数组 `companion_need_map[x][y]`

### 2) 满足需求（需求格子优先）

当无人机走到某个格子时，如果该格子在 `companion_need_map` 中被标记为“需求点位”：

- 优先把该格子种成需求的植物类型
- 胡萝卜需求会遵守耕地规则：只在 `Grassland` 时 `till()`，避免二次 till 切回草地
- 脚本在处理完该需求点位后会将该格子的需求清空，避免长期占用导致分区逻辑无法回补

### 3) 与现有分区的关系

- 伴生需求层只在**南瓜区外**生效
  - 若伴生目标落在南瓜合并区，会被忽略，避免破坏南瓜合并
- 在南瓜区外：
  - 伴生需求点位的优先级高于默认“胡萝卜/树/向日葵/草”分区逻辑

### 4) 冲突处理（同一格子被多次请求）

如果多个植物请求同一个目标格子（需要种的伴生类型不同）：

- 脚本会按优先级保留更“重要”的需求（可按资源情况调整）
  - 推荐默认优先级：`Tree > Bush > Carrot > Grass`

## 实战建议（怎么调得更赚）

- 如果你缺木材：提高 `Tree/Bush` 的优先级，或扩大树点位密度
- 如果你缺胡萝卜（南瓜消耗）：提高 `Carrot` 的优先级，并结合肥料策略加速补给
- 若发现分区被伴生需求“扰动”太大：
  - 可以把“伴生需求只允许覆盖草点位”的限制加回去（更稳，但收益略低）
