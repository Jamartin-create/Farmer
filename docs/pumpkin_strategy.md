# 南瓜策略（小地图动态合并区版）

本文用于《The Farmer Was Replaced》脚本策略记录，目标是：在**世界大小为 `n×n`** 时，自动选择一个较小的正方形区域进行南瓜合并，并正确处理枯萎南瓜、耕地开关等规则。

## 设计目标

- **动态合并区**：当地图较小（例如 `6×6`）时，使用比 `6×6` 更小的合并区，避免“整图都当南瓜区”导致资源链不稳、维护困难。
- **维护优先于收割**：普通成熟南瓜**不要收割**，优先让其参与“整块完全成熟后自动合并”为巨型南瓜。
- **快速修复枯萎点**：枯萎南瓜会阻止合并，必须尽快补种替换。

## 动态合并区大小

令世界大小为 `n = get_world_size()`，合并区边长定义为：

\[
m = n - \lfloor n/2 \rfloor
\]

合并区面积为：

\[
m \times m
\]

### 示例

- `n = 6`：
  - \(\lfloor 6/2 \rfloor = 3\)
  - \(m = 6 - 3 = 3\)
  - 合并区为 **3×3**

> 说明：你写的 `(n - n/2)` 在脚本里通常按整数除法理解（即 `n // 2`），对应上面的 \(\lfloor n/2 \rfloor\)。

## 合并区位置（推荐：左上角对齐）

为了让规则简单、可读、好调试，建议把合并区固定为左上角：

- 合并区坐标范围：`0 <= x < m` 且 `0 <= y < m`

其余区域可以用于胡萝卜（作为南瓜种植消耗的资源链）、树等。

## 南瓜区维护规则（核心逻辑）

对合并区内每个格子，建议按以下顺序处理：

### 1) 处理“耕地开关”（非常重要）

- 南瓜只能种在 `Grounds.Soil` 上
- `till()` 是开关：`Grassland -> Soil -> Grassland`
- 因此只能在需要时才 `till()`：
  - 若 `get_ground_type() == Grounds.Grassland`，再 `till()` 一次
  - 否则不要 `till()`，避免误切回草地

### 2) 枯萎南瓜：只补种，不收割

- 枯萎南瓜会阻止合并
- `can_harvest()` 对枯萎南瓜始终为 `False`
- 正确处理方式：
  - 直接 `plant(Entities.Pumpkin)` 覆盖补种（会自动移除枯萎南瓜）

### 3) 普通成熟南瓜：不要收割

- 普通成熟南瓜应该保留，让合并区“全成熟后自动合并”为巨型南瓜
- 所以**不要写**“能收就 harvest”来处理南瓜区

### 4) 巨型南瓜：只收它（用“全区成熟”触发收割）

- 合并触发条件是：合并区内南瓜**全部完全成熟**
- 因为游戏脚本没有单独暴露“巨型南瓜实体名”，脚本实现采用更稳定的判定方式：
  - **维护一个 m×m 的成熟度缓存数组**（每格是否为 `Entities.Pumpkin` 且 `can_harvest()==True`）
  - 当检测到“全区成熟”时，置一个 `ready_to_harvest` 标记
  - 之后在南瓜区遇到任意可收割的 `Entities.Pumpkin` 时执行 `harvest()`（等价于收割巨型南瓜），并清空缓存进入下一轮

### 5) 空地：补种南瓜

- 若 `get_entity_type() == None`：
  - 先确保 `Grounds.Soil`
  - 再 `plant(Entities.Pumpkin)`

## 资源链建议（小地图版）

因为“种南瓜会消耗胡萝卜”，在小地图（例如 `6×6`）中建议：

- **合并区（m×m）**：专心做南瓜合并循环
- **剩余区域**：稳定产胡萝卜（或混合树等），确保胡萝卜库存能支撑持续补种

## 实现注意点（写代码时对照）

- 南瓜区的收获规则必须和其他作物区分开：
  - **其他作物区**可以“能收就收”
  - **南瓜区**必须“只收巨型南瓜 + 枯萎点直接补种”
- `till()` 必须是“检查后再调用”，不能无脑耕地
