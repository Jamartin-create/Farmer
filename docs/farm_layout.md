# 农场分区策略（南瓜 + 多作物混种）

本文描述 `do_plant.py` 当前采用的**分区种植**策略：在同一张小地图上同时种南瓜、胡萝卜、树、草，并且遵守“耕地是开关”“枯萎南瓜不能收割”等规则。

## 1) 南瓜合并区（动态大小）

- 世界边长：`n = get_world_size()`
- 合并区边长：\(m = n - \lfloor n/2 \rfloor\)
- 合并区位置：左上角
  - `0 <= x < m` 且 `0 <= y < m`

### 南瓜区维护规则

- **耕地**：需要种南瓜时，必须先确保 `Grounds.Soil`，且只在 `Grassland` 时 `till()`（避免二次 till 切回草地）。
- **枯萎南瓜**（`Entities.Dead_Pumpkin`）：`can_harvest()` 永远 `False`，不要收割；直接 `plant(Entities.Pumpkin)` 覆盖补种即可自动移除。
- **普通成熟南瓜**：不提前 harvest，等待整块全成熟后合并。
- **“巨型南瓜”收割判定**：
  - 游戏没有单独的“巨型南瓜实体名”，因此脚本用“成熟且四邻没有 Pumpkin（孤立 Pumpkin）”来近似判断合并后的巨型南瓜，然后才 harvest。

## 2) 南瓜区外：多作物分区（混种）

为了让"南瓜消耗胡萝卜"的资源链稳定，同时保留木材/干草来源，南瓜区外采用多类区域：

### 2.1 胡萝卜供给环带（Carrot）

目的：为南瓜补种提供胡萝卜库存。

定义（贴着南瓜区外沿的一圈，厚度 1 格）：

- 右侧竖边：`y < m` 且 `x == m`
- 下侧横边：`x < m` 且 `y == m`

规则：

- 胡萝卜必须在 `Grounds.Soil` 上种植：仅当 `get_ground_type()==Grounds.Grassland` 时 `till()` 一次。
- 能收就收，收完立刻补种胡萝卜。

### 2.2 仙人掌区（Cactus，南瓜区右侧）

目的：种植仙人掌，通过排序机制实现连锁收集，获得 n² 倍收获奖励。

定义（位于南瓜区右侧，与南瓜区相邻）：

- 区域：`m+1 <= x < min(2*m+1, n)` 且 `0 <= y < m`
- 注意：胡萝卜供给环带优先级更高（`x == m` 或 `y == m`），会先处理，因此仙人掌区从 `m+1` 开始，避免重叠

规则：

- 仙人掌必须在 `Grounds.Soil` 上种植：仅当 `get_ground_type()==Grounds.Grassland` 时 `till()` 一次。
- 空地：直接补种仙人掌
- 成熟仙人掌：能收就收，收完补种（连锁收集由游戏自动处理）
- 其他作物：可收则收掉再换种；不可收则暂时保留

详细策略请参考 `docs/cactus_strategy.md`。

### 2.3 树区（Tree，全图棋盘格 + 邻居避让）

目的：提供木材，同时尽量避免树的“相邻减速”（相邻树会使生长时间翻倍，最坏 16 倍）。

定义（南瓜区外、且不在胡萝卜供给圈内的区域，采用棋盘格）：

- 棋盘格：`(x + y) % 2 == 0` 的格子作为树点位（覆盖更大区域，提高木材产能）

额外规则：

- 若脚本缓存地图检测到四邻已存在树，则此格改种草，降低相邻树概率（避免生长时间翻倍叠加）。

### 2.4 其余区域（Grass）

目的：提供干草来源/兜底占位。

规则：

- 能收就收，空地补草。
- 草可种在草地或土壤上，不需要 `till()`。

### 2.5 向日葵区（Sunflower，棋盘格另一半）

目的：提供能量（Power），在有能量时无人机 2× 速度运行；并在满足条件时拿到 **8× 能量加成**。

定义：

- 向日葵点位使用棋盘格的"另一半"：`(x + y) % 2 == 1`
- 注意：胡萝卜供给圈和仙人掌区优先级更高（先判定），因此向日葵不会占用这些区域。

规则：

- 需要先确保 `Grounds.Soil`（只在 `Grassland` 时 `till()`，避免二次 till 切回草地）
- `measure()` 可在未成熟时测花瓣（7~15），脚本会缓存每格的花瓣数
- 当向日葵数量 `< 10` 时：优先铺量，不急着收割
- 当向日葵数量 `>= 10` 时：只收割“当前最大花瓣数”的成熟向日葵（允许并列最大），以满足 8× 规则

## 3) 通用处理（所有“非南瓜合并区”作物）

在胡萝卜/树/草的区域，脚本使用统一规则：

- `Entities.Dead_Pumpkin`：可被新种植覆盖，直接补种目标作物
- `None`（空地）：直接补种目标作物
- 已是目标作物：能收就收，收完补种
- 是其他作物：
  - 若能收：收掉再换种
  - 不可收：暂时保留（避免强行覆盖导致异常）
